# Workflow name displayed in GitHub Actions UI
name: Deploy to Server

# Trigger: Run this workflow when code is pushed to the main branch
on:
  push:
    branches:
      - main

jobs:
  deploy:
    # Use GitHub's Ubuntu runner to execute the job
    runs-on: ubuntu-latest

    steps:
      # Connect to remote server via SSH and run deployment commands
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          # Server connection details stored as GitHub secrets for security
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Commands to run on the remote server
          script: |
            cd /var/www/fastapi_app          # Navigate to the project directory
            git pull origin main            # Pull latest code from main branch
            docker compose down             # Stop running containers
            docker compose up -d --build    # Rebuild and start containers in detached mode
            echo "Deployment completed at $(date)"  # Log completion time